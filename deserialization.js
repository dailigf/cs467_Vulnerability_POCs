module.exports = function () {
	var express = require('express');
	var serialize = require('node-serialize');

	var router = express.Router();

	function myJSONParse(data){
		return eval(`(${data})`);
	}

	router.get('/', function(req, res){
		/*
		 * Root page for /insecure-deserialization page
		 */
		res.render('deserialization.handlebars')

	});

	router.post('/serialize', function(req, res){
		/*
		 * Root page for /sqli page
		 */
		var obj = req.body.text;
		console.log('payload:\n' + obj);

		//serialize the text first
		var serialized = serialize.serialize(obj);
		console.log('serialized:\n' + serialized);

		var context = {};
		context.serialized = serialized;

		//var unserialized = serialize.unserialize(obj);

		//console.log('unserialized:\n' + unserialized);
		res.render('deserialization.handlebars', context);

	});

	router.post('/deserialize', function(req, res){
		/*
		 * Root page for /sqli page
		 */

		var context = {};
		var obj = req.body.text;
		console.log(obj)
		var deserialized = serialize.unserialize(obj);
		console.log(deserialized);

		var concatenated_string = '';
		for(const[key, value] of Object.entries(deserialized)){
			concatenated_string += value;
		}
		console.log(concatenated_string)
		context.unserialized = concatenated_string;
		res.render('deserialization.handlebars', context);

	});
	return router;

}();
