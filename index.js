module.exports = function () {
	var express = require('express');
	var router = express.Router();
	var axios = require('axios');
	const url = require('url');

	async function callJaqService(queryParam){
		/* This function will be used to call Jaq's microservice
		 * :param queryParam: This is the word that is to be defined
		 * :type queryParam: string
		 *
		 * :return: returns the response from Jaqs microservice
		 * :rtype: json response object
		 */
		let payload = {"query": queryParam};
		const params = new url.URLSearchParams(payload);
		const jaqURL = `http://127.0.0.1:31337/dApp/jaq?${params}`;
		let res = await axios.get(jaqURL);
		return res
	};

	async function createTxObject(address, seller){
		/* This function will be used to create a transaction object
		 * :param address: wallet address of the buy
		 * :type addres: hex string
		 * :param seller: wallet address of the seller
		 * :type seller: hex string
		 *
		 * :return: returns a transaction object
		 * :rtype: json map
		 */
		const txObject = {
			nonce: web3.utils.toHex(await web3.eth.getTransactionCount(address)),
			from: address,
			to: seller,
			value: web3.utils.toHex(web3.utils.toWei('1', 'ether')),
			gasLimit: '0x6691B7',
			gasPrice: web3.utils.toHex(web3.utils.toWei('1', 'gwei'))
		};

		return txObject;

	}

	async function getBalance_Improved(address){
		/* This function will get the balance of an address
		 * :param address: The address of a wallet
		 * :type address: hex string
		 *
		 * :return: balance of an address
		 * :rtype: int
		 */
		return web3.eth.getBalance(address);
	}


	async function writeTransaction_Improved(address, seller, context){
		/* This function will write a transaction to the bock chain
		 * :param address: hexadecimal string that represents the wallet address
		 * :type address: string
		 *
		 * :param context: map that will be used to store variables
		 * :type context: map
		 */
		const txObject = await createTxObject(address, seller);

		const tx = new Tx(txObject);
		tx.sign(Buffer.from(privateKeys.get(address),'hex'));

		const serializedTransaction = tx.serialize();
		const raw = serializedTransaction.toString('hex');

		const txHash = (await web3.eth.sendSignedTransaction(raw))["transactionHash"];

		const txObj = await web3.eth.getTransactionReceipt(txHash);

		context.purchase_price = {'purchase_price': parseInt(txObject.value, 16).toString()};
		context.gas_used = {'gas_used': web3.utils.toWei(txObj.gasUsed.toString(), 'gwei').toString()};
		context.receipt = {'receipt': txHash};
	}


	async function getAddresses_Improved(){
		/* This function will be used the public key wallet addresses from the block chain
		 * :return: addresses on the block chain
		 * :rtype: array
		 */
		var addresses = []
		const accounts = await web3.eth.getAccounts();
		for(let i = 0; i < accounts.length; i++){
			let myObj = { "address": accounts[i] };
			addresses.push(myObj);
		}
		return addresses
	}



	router.get('/', async (req, res) => {
		/*
		 * Root page for /dApp. Function will retrieve wallet addresses. 
		 */
		var context = {};
		//context.jsscripts = ["verifyFunds.js", "icons.js"];
		//context.Addresses = await getAddresses_Improved();
		console.log('req.query');
		console.log(req.query.text);
		context.text = req.query.text;
		console.log('printing context');
		console.log(context);
		res.render('index.handlebars', context);
	});


	router.get('/verifyFunds', async (req, res) => {
		/*
		 * Route that is called when user 'clicks' on 'Verify Funds'.  This will get balance for target wallet
		 * Will call getAddresses.
		 */
		var callbackcount = 0;
		var context = {};
		context.jsscripts = ["verifyFunds.js", "translate.js"];
		context.Addresses = await getAddresses_Improved();
		context.curr_Address = req.query;
		const balance = await getBalance_Improved(req.query.query);
		context.funds = {"balance": balance};
		res.render('dApp.handlebars', context);
	});

	router.post('/', async (req, res) => {
		/*
		 * This Route will receive form inputs when the user clicks on 'translate'.  It will deduct funds from
		 * the buyer to the seller.  The seller is Jaq's web address.
		 */
		var context = {}
		context.jsscripts = ["verifyFunds.js", "translate.js"];

		/*Call Jaqs Microservice*/
		const jaqResponse = await callJaqService(req.body.text);
		let data = jaqResponse.data;

		context.word = {"word": data["word"]};
		delete data["word"];
		context.definition = data;

		context.buyer = {'buyer': req.body.buyer};

		//Get Buyer's starting balance
		context.buyer_start_bal = {"buyer_start_bal": await getBalance_Improved(req.body.buyer)};

		//Execute a transaction
		await writeTransaction_Improved(req.body.buyer, seller, context);

		//Get Buyer's ending balance
		context.buyer_end_bal = {"buyer_end_bal": await getBalance_Improved(req.body.buyer)};

		//Get Addressed
		context.Addresses = await getAddresses_Improved();

		//Dummy Translated Text
		//var text = "This is a dummy text, to be translated in the future";
		//context.translated = {'translated_text': text};
		//context.original = {'original_text': req.body.text};

		//console.log(context)

		res.render('dApp.handlebars', context);

	});

	router.post('/jaq', async (req, res) => {
		/*
		 * This is the API call for Jaq's application.  The function will receive the buyers wallet address and execute a transaction
		 * It will transfer funds from the buyer to Jaq's wallet address.
		 */
		var context = {}
		context.jsscripts = ["verifyFunds.js", "translate.js"];

		//Get Buyer's starting balance
		context.buyer_start_bal = {"buyer_start_bal": await getBalance_Improved(req.body.buyer)};

		//Get Jaq's starting balance
		context.jaq_start_bal = {'jaq_start_bal': await getBalance_Improved(req.body.jaq)};

		//Execute a transaction
		await writeTransaction_Improved(req.body.buyer, req.body.jaq, context);

		//Get Addressed
		context.Addresses = await getAddresses_Improved();

		//Get Seller Ending Balance
		context.jaq_end_bal = {'jaq_end_bal': await getBalance_Improved(req.body.jaq)};

		//Check to see if funds deposited
		const fundDeposited = (context.jaq_end_bal.jaq_end_bal > context.jaq_start_bal.jaq_start_bal) ? true:false;

		res.status(200).json({
                	"jaq_start_bal": context.jaq_start_bal.jaq_start_bal,
                	"jaq_end_bal": context.jaq_end_bal.jaq_end_bal,
                	"txHash": context.receipt.receipt,
                	"fundDeposited": fundDeposited

		});

	});

	router.get('/jaq', async (req, res) => {
		/*
		 * Root page for /jaq. This route will be used to simulate a test against Jaq's microservice. 
		 */

		res.status(200).json({
			"word":	"younger",
			"definition1": "having the qualities popularly associated with young people, such as enthusiasm and optimism.",
			"definition2": "immature or inexperienced"
		});


	});

	return router;

}();
